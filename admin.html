<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Panel - Product Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="text-gray-800 bg-gray-100">

    <div class="flex items-center bg-gray-100 justify-center min-h-screen" id="login-container">
        <div class="w-full bg-white max-w-sm p-8 rounded-xl shadow-lg">
            <h2 class="font-bold mb-6 text-3xl text-center text-indigo-700">Admin Login</h2>
            <form class="space-y-4" id="login-form">
                <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Admin ID" required id="username">
                <div class="relative">
                    <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Password" required type="password" id="password">
                    <button class="px-4 absolute focus:outline-none inset-y-0 right-0 text-gray-500" id="toggle-password" type="button" aria-label="Toggle password visibility">
                        <svg class="hidden h-5 w-5" fill="none" id="eye-open" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <svg class="h-5 w-5" fill="none" id="eye-closed" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.42 3.49"></path>
                            <path d="M15 15a3 3 0 1 0-3-3"></path>
                            <line x1="1" x2="23" y1="1" y2="23"></line>
                        </svg>
                    </button>
                </div>
                <button class="rounded-lg w-full bg-indigo-600 disabled:bg-indigo-400 disabled:cursor-not-allowed duration-300 font-bold hover:bg-indigo-700 px-6 py-3 relative text-white transition-colors" id="login-button" type="submit">
                    <span id="login-button-text">Login</span>
                    <svg class="hidden h-5 w-5 -ml-2.5 -mt-2.5 absolute animate-spin left-1/2 text-white top-1/2" fill="none" id="login-spinner" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" class="opacity-25" stroke="currentColor" stroke-width="4"></circle>
                        <path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75" fill="currentColor"></path>
                    </svg>
                </button>
                <p class="hidden text-center text-red-500 text-sm" id="login-error">Invalid credentials. Please try again.</p>
            </form>
        </div>
    </div>

    <div class="hidden" id="admin-panel">
        <header class="bg-white py-6 shadow-sm">
            <div class="px-4 container mx-auto flex items-center justify-between">
                <div class="text-center flex-grow">
                    <h1 class="font-extrabold text-4xl text-indigo-700">Admin Panel</h1>
                    <p class="text-gray-500 mt-2">Manage your e-commerce platform.</p>
                </div>
                <button class="rounded-lg transition-colors py-2 text-white bg-red-600 font-bold hover:bg-red-700 px-6" id="logout-button">Logout</button>
            </div>
        </header>

        <nav class="bg-gray-200 shadow-md">
            <div class="px-4 container mx-auto flex py-3 space-x-4">
                <button class="rounded-lg transition-colors py-2 duration-200 px-4 tab-button bg-indigo-600 font-semibold text-white" id="tab-products">Products</button>
                <button class="rounded-lg transition-colors py-2 duration-200 px-4 tab-button hover:bg-gray-300 text-gray-600" id="tab-users">Users</button>
                <button class="rounded-lg transition-colors py-2 duration-200 px-4 tab-button hover:bg-gray-300 text-gray-600" id="tab-orders">Orders</button>
            </div>
        </nav>

        <main class="px-4 container mx-auto py-8">
            <section id="section-products">
                <div class="grid grid-cols-1 gap-8 md:grid-cols-3">
                    <div class="bg-white p-8 rounded-xl shadow-lg h-fit md:col-span-1">
                        <h2 class="font-bold text-2xl text-gray-800 mb-6">Add/Update Product</h2>
                        <form class="space-y-4" id="product-form">
                            <input name="original-name" type="hidden" id="product-original-name">
                            <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Name" required name="name">
                            <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Price" required name="price" type="text">
                            <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Discount (e.g., '10%' or '$5')" name="discount" type="text">
                            <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Category" required name="category">
                            <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Description" required name="description">
                            <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Stock" required name="stock" type="number">
                            <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Image URL" required name="image" type="url">
                            
                            <div id="small-images-container" class="space-y-2">
                                <h3 class="font-semibold text-gray-700 mb-2">Small Images (Optional)</h3>
                                <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Small Image URL 1" name="smallImage1" type="url">
                                <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Small Image URL 2" name="smallImage2" type="url">
                                <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Small Image URL 3" name="smallImage3" type="url">
                                <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Small Image URL 4" name="smallImage4" type="url">
                            </div>

                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">Product Selections</h3>
                                <div id="selections-container" class="space-y-2"></div>
                                <div class="flex space-x-2 mt-2">
                                    <button type="button" id="add-selection-btn" class="flex-1 rounded-lg px-4 py-2 bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">Add Selection</button>
                                </div>
                            </div>

                            <button class="rounded-lg w-full bg-indigo-600 disabled:bg-indigo-400 disabled:cursor-not-allowed duration-300 font-bold hover:bg-indigo-700 px-6 py-3 relative text-white transition-colors" id="submit-button" type="submit">
                                <span id="submit-button-text">Add Product</span>
                                <svg class="hidden h-5 w-5 -ml-2.5 -mt-2.5 absolute animate-spin left-1/2 text-white top-1/2" fill="none" id="submit-spinner" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="10" class="opacity-25" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75" fill="currentColor"></path>
                                </svg>
                            </button>
                        </form>
                    </div>

                    <div class="md:col-span-2">
                        <h2 class="font-bold text-2xl text-gray-800 mb-6">Product List</h2>
                        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2 sm:grid-cols-2" id="product-list">
                            <p class="text-center text-gray-500 col-span-full">Loading products...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="section-users" class="hidden">
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="font-bold text-2xl text-gray-800 mb-4">User Management</h2>
                    <div class="mb-4">
                        <input class="rounded-lg w-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" placeholder="Search users by name or email..." id="user-search-input">
                    </div>
                    <div class="space-y-4" id="user-list">
                        <p class="text-center text-gray-500">Loading users...</p>
                    </div>
                </div>
            </section>

            <section id="section-orders" class="hidden">
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="font-bold text-2xl text-gray-800 mb-4">Order History</h2>
                    <div class="space-y-4" id="order-list">
                        <p class="text-center text-gray-500">Loading orders...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="selection-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative bg-white p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3">
            <h3 class="font-bold text-xl text-gray-800 mb-4">Add/Edit Selection</h3>
            <form class="space-y-4" id="selection-form">
                <div>
                    <label for="selection-type" class="block text-sm font-medium text-gray-700">Selection Type</label>
                    <select id="selection-type" class="mt-1 block w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3">
                        <option value="size">Size (e.g., S, M, L)</option>
                        <option value="color">Color (e.g., Red, Blue, Green)</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div>
                    <label for="selection-name" class="block text-sm font-medium text-gray-700">Custom Selection Name</label>
                    <input type="text" id="selection-name" placeholder="e.g., Material, Flavour" class="mt-1 block w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-3" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Selection Values</label>
                    <div id="selection-values-container" class="space-y-2 mt-1"></div>
                    <button type="button" id="add-value-btn" class="mt-2 w-full rounded-lg px-4 py-2 bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">Add Value</button>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-selection-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">Save Selection</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- TOKEN MANAGEMENT FUNCTIONS ---
        function getToken() {
            return localStorage.getItem('adminToken');
        }

        function setToken(token) {
            localStorage.setItem('adminToken', token);
        }

        function removeToken() {
            localStorage.removeItem('adminToken');
        }

        // --- DOM ELEMENTS ---
        const loginContainer = document.getElementById('login-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const loginError = document.getElementById('login-error');
        const productForm = document.getElementById('product-form');
        const productList = document.getElementById('product-list');
        const productOriginalName = document.getElementById('product-original-name');
        const submitButton = document.getElementById('submit-button');
        const submitButtonText = document.getElementById('submit-button-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const loginButton = document.getElementById('login-button');
        const loginButtonText = document.getElementById('login-button-text');
        const loginSpinner = document.getElementById('login-spinner');
        const togglePassword = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('password');

        const tabProducts = document.getElementById('tab-products');
        const tabUsers = document.getElementById('tab-users');
        const tabOrders = document.getElementById('tab-orders');
        const sectionProducts = document.getElementById('section-products');
        const sectionUsers = document.getElementById('section-users');
        const sectionOrders = document.getElementById('section-orders');
        const userSearchInput = document.getElementById('user-search-input');
        const userList = document.getElementById('user-list');
        const orderList = document.getElementById('order-list');
        
        let allUsers = [];

        // New DOM Elements for Selections
        const selectionsContainer = document.getElementById('selections-container');
        const addSelectionBtn = document.getElementById('add-selection-btn');
        const selectionModal = document.getElementById('selection-modal');
        const selectionForm = document.getElementById('selection-form');
        const selectionType = document.getElementById('selection-type');
        const selectionNameInput = document.getElementById('selection-name');
        const selectionValuesContainer = document.getElementById('selection-values-container');
        const addValueBtn = document.getElementById('add-value-btn');
        const cancelSelectionBtn = document.getElementById('cancel-selection-btn');
        const smallImagesContainer = document.getElementById('small-images-container');

        let currentSelections = [];

        // --- UI STATE FUNCTIONS ---
        function showLoginForm() {
            loginContainer.classList.remove('hidden');
            adminPanel.classList.add('hidden');
        }

        function showAdminPanel() {
            loginContainer.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            if (tab === 'users') {
                showSection('section-users');
                loadUsers();
            } else if (tab === 'orders') {
                showSection('section-orders');
                loadOrders();
            } else {
                showSection('section-products');
                loadProducts();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            if (getToken()) {
                showAdminPanel();
            } else {
                showLoginForm();
            }
        });

        function showSection(sectionId) {
            const sections = [sectionProducts, sectionUsers, sectionOrders];
            sections.forEach(sec => sec.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');

            const tabs = [tabProducts, tabUsers, tabOrders];
            tabs.forEach(tab => {
                tab.classList.remove('bg-indigo-600', 'text-white', 'font-semibold');
                tab.classList.add('text-gray-600', 'hover:bg-gray-300');
            });

            const activeTab = document.getElementById(`tab-${sectionId.replace('section-', '')}`);
            activeTab.classList.add('bg-indigo-600', 'text-white', 'font-semibold');
            activeTab.classList.remove('text-gray-600', 'hover:bg-gray-300');
        }

        function updateURL(tabName) {
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.pushState({}, '', url);
        }

        // --- Event Listeners ---
        tabProducts.addEventListener('click', () => {
            showSection('section-products');
            loadProducts();
            updateURL('products');
        });

        tabUsers.addEventListener('click', () => {
            showSection('section-users');
            loadUsers();
            updateURL('users');
        });

        tabOrders.addEventListener('click', () => {
            showSection('section-orders');
            loadOrders();
            updateURL('orders');
        });

        // Toggle password visibility
        togglePassword.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            const eyeOpen = document.getElementById('eye-open');
            const eyeClosed = document.getElementById('eye-closed');
            eyeOpen.classList.toggle('hidden');
            eyeClosed.classList.toggle('hidden');
        });

        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginButton.disabled = true;
            loginButtonText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');
            
            const username = e.target.username.value;
            const password = e.target.password.value;

            try {
                const res = await fetch('https://test-ecommerce-backend-icgy.onrender.com/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: username, password })
                });

                if (!res.ok) {
                    throw new Error('Login failed');
                }

                const data = await res.json();
                setToken(data.token);
                loginError.classList.add('hidden');
                showAdminPanel();
            } catch (err) {
                console.error('Login failed:', err);
                loginError.classList.remove('hidden');
            } finally {
                loginButton.disabled = false;
                loginButtonText.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
            }
        });

        logoutButton.addEventListener('click', () => {
            removeToken();
            showLoginForm();
        });

        // --- New functions for Selection Management ---
        function renderSelections() {
            selectionsContainer.innerHTML = '';
            currentSelections.forEach((sel, index) => {
                const selectionDiv = document.createElement('div');
                selectionDiv.className = 'bg-gray-100 p-3 rounded-lg flex items-center justify-between';
                const valuesHtml = sel.values.map(v => {
                    const valueName = v.name;
                    const valueImage = v.imageUrl ? `<img src="${v.imageUrl}" class="w-6 h-6 rounded-full inline-block mr-1" alt="${valueName}">` : '';
                    const valuePrice = v.price ? ` ($${v.price})` : '';
                    return `<span>${valueImage}${valueName}${valuePrice}</span>`;
                }).join(', ');
                
                selectionDiv.innerHTML = `
                    <div>
                        <span class="font-bold text-sm">${sel.name}:</span>
                        <span class="text-sm">${valuesHtml}</span>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="deleteSelection(${index})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                selectionsContainer.appendChild(selectionDiv);
            });
        }

        function deleteSelection(index) {
            currentSelections.splice(index, 1);
            renderSelections();
        }

        function showSelectionModal() {
            selectionModal.classList.remove('hidden');
            clearSelectionValues();
            addSelectionValueInput();
        }

        function hideSelectionModal() {
            selectionModal.classList.add('hidden');
            selectionForm.reset();
            selectionNameInput.disabled = true;
            selectionNameInput.value = '';
            clearSelectionValues();
        }

        function clearSelectionValues() {
            selectionValuesContainer.innerHTML = '';
        }
        
        function addSelectionValueInput(value = '', imageUrl = '', price = '') {
            const valueDiv = document.createElement('div');
            valueDiv.className = 'flex space-x-2 items-center';
            valueDiv.innerHTML = `
                <input type="text" placeholder="Value (e.g., Red, S)" class="flex-1 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-2 selection-value-name" value="${value}" required>
                <input type="number" placeholder="Price (optional)" class="flex-1 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-2 selection-value-price" value="${price}">
                <input type="url" placeholder="Image URL (optional)" class="flex-1 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-2 selection-value-image" value="${imageUrl}">
                <button type="button" class="p-1 text-red-500 hover:text-red-700 remove-value-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            selectionValuesContainer.appendChild(valueDiv);
            valueDiv.querySelector('.remove-value-btn').addEventListener('click', () => {
                valueDiv.remove();
            });
        }

        // --- Event Listeners for Selections ---
        addSelectionBtn.addEventListener('click', () => {
            showSelectionModal();
        });

        cancelSelectionBtn.addEventListener('click', () => {
            hideSelectionModal();
        });
        
        addValueBtn.addEventListener('click', () => {
            addSelectionValueInput();
        });

        selectionType.addEventListener('change', (e) => {
            selectionNameInput.disabled = e.target.value !== 'custom';
            if (e.target.value === 'custom') {
                selectionNameInput.focus();
            } else {
                selectionNameInput.value = '';
            }
        });

        selectionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const type = selectionType.value;
            const name = type === 'custom' ? selectionNameInput.value.trim() : selectionType.options[selectionType.selectedIndex].text.split(' ')[0];
            
            const valueInputs = selectionValuesContainer.querySelectorAll('.selection-value-name');
            const imageUrlInputs = selectionValuesContainer.querySelectorAll('.selection-value-image');
            const priceInputs = selectionValuesContainer.querySelectorAll('.selection-value-price');

            const values = Array.from(valueInputs).map((input, index) => {
                return {
                    name: input.value.trim(),
                    imageUrl: imageUrlInputs[index].value.trim(),
                    price: priceInputs[index].value.trim() !== '' ? parseFloat(priceInputs[index].value) : undefined
                };
            }).filter(v => v.name !== '');

            if (!name || values.length === 0) {
                alert('Please provide a name and at least one value for the selection.');
                return;
            }

            currentSelections.push({ name, values });
            renderSelections();
            hideSelectionModal();
        });

        // --- PRODUCT MANAGEMENT ---
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitButton.disabled = true;
            submitButtonText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');

            const form = e.target;
            const originalName = form['original-name'].value;
            
            const smallImages = [
                form.smallImage1.value,
                form.smallImage2.value,
                form.smallImage3.value,
                form.smallImage4.value,
            ].filter(url => url.trim() !== '');

            const product = {
                name: form.name.value,
                price: parseFloat(form.price.value),
                discount: form.discount.value,
                category: form.category.value,
                description: form.description.value,
                stock: parseInt(form.stock.value, 10),
                image: form.image.value,
                smallImages: smallImages,
                selections: currentSelections,
            };

            const token = getToken();
            let url = 'https://test-ecommerce-backend-icgy.onrender.com/api/products';
            let method = 'POST';

            if (originalName) {
                url = `https://test-ecommerce-backend-icgy.onrender.com/api/products/${encodeURIComponent(originalName)}`;
                method = 'PUT';
            }

            try {
                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(product),
                });

                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        removeToken();
                        showLoginForm();
                        alert('Session expired. Please log in again.');
                    }
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Failed to save product');
                }

                form.reset();
                productOriginalName.value = '';
                submitButtonText.textContent = 'Add Product';
                currentSelections = [];
                renderSelections();
                loadProducts();
            } catch (err) {
                console.error('Failed to save product:', err);
                alert(err.message);
            } finally {
                submitButton.disabled = false;
                submitButtonText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        });

        function editProduct(product) {
            productForm.name.value = product.name;
            productForm.price.value = product.price;
            productForm.discount.value = product.discount || '';
            productForm.category.value = product.category;
            productForm.description.value = product.description;
            productForm.stock.value = product.stock;
            productForm.image.value = product.image;
            productOriginalName.value = product.name;
            
            // Populate small images
            const smallImageInputs = smallImagesContainer.querySelectorAll('input');
            smallImageInputs.forEach((input, index) => {
                input.value = product.smallImages && product.smallImages[index] ? product.smallImages[index] : '';
            });

            submitButtonText.textContent = 'Update Product';
            currentSelections = product.selections || [];
            renderSelections();
        }

        async function deleteProduct(name) {
            if (!confirm(`Are you sure you want to delete ${name}?`)) return;
            const token = getToken();
            try {
                const res = await fetch(`https://test-ecommerce-backend-icgy.onrender.com/api/products/${encodeURIComponent(name)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        removeToken();
                        showLoginForm();
                        alert('Session expired. Please log in again.');
                    }
                    throw new Error('Failed to delete product.');
                }
                loadProducts();
            } catch (err) {
                console.error('Delete failed:', err);
                alert('Failed to delete product.');
            }
        }

        async function loadProducts() {
            productList.innerHTML = `<p class="col-span-full text-center text-gray-500 flex items-center justify-center">
                                         <svg class="animate-spin h-5 w-5 mr-3 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                             <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                             <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                         </svg> Loading products...
                                     </p>`;

            try {
                const res = await fetch('https://test-ecommerce-backend-icgy.onrender.com/api/products');

                if (!res.ok) {
                    throw new Error('Network response was not ok.');
                }

                const products = await res.json();
                productList.innerHTML = '';
                if (products.length === 0) {
                    productList.innerHTML = '<p class="col-span-full text-center text-gray-500">No products found.</p>';
                    return;
                }
                products.forEach(p => {
                    const productDiv = document.createElement('div');
                    productDiv.className = `bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex items-center space-x-4`;
                    productDiv.innerHTML = `
                        <div class="flex-shrink-0">
                            <img src="${p.image}" alt="${p.name}" class="w-16 h-16 object-cover rounded-lg">
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-900">${p.name}</h3>
                            <p class="text-sm text-gray-600">Price: <span class="font-semibold">$${p.price}</span></p>
                            <p class="text-xs text-gray-500">Category: ${p.category}</p>
                            <p class="text-xs text-gray-500">Stock: ${p.stock}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-btn flex-shrink-0 p-2 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition-colors" data-product='${JSON.stringify(p)}'>
                                Edit
                            </button>
                            <button onclick="deleteProduct('${p.name.replace(/'/g, "\\'")}')" class="flex-shrink-0 p-2 text-sm bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                                Delete
                            </button>
                        </div>
                    `;
                    productList.appendChild(productDiv);
                });

                // Attach event listeners for edit buttons after they've been created
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productData = JSON.parse(e.currentTarget.getAttribute('data-product'));
                        editProduct(productData);
                    });
                });

            } catch (err) {
                console.error('Failed to load products:', err);
                productList.innerHTML = '<p class="col-span-full text-center text-red-500">Failed to load products.</p>';
            }
        }

        // --- User Management Functions ---
        async function loadUsers() {
            userList.innerHTML = `<p class="text-center text-gray-500 flex items-center justify-center">
                                    <svg class="animate-spin h-5 w-5 mr-3 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg> Loading users...
                                 </p>`;

            try {
                const res = await fetch('https://test-ecommerce-backend-icgy.onrender.com/api/users', {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        removeToken();
                        showLoginForm();
                        alert('Session expired. Please log in again.');
                    }
                    throw new Error('Failed to load users.');
                }
                
                allUsers = await res.json();
                renderUsers(allUsers);
            } catch (err) {
                console.error('Failed to load users:', err);
                userList.innerHTML = '<p class="text-center text-red-500">Failed to load users.</p>';
            }
        }

        function renderUsers(users) {
            userList.innerHTML = '';
            if (users.length === 0) {
                userList.innerHTML = '<p class="text-center text-gray-500">No users found.</p>';
                return;
            }
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = `bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center`;
                userDiv.innerHTML = `
                    <div>
                        <p class="font-bold text-lg text-gray-900">${user.name}</p>
                        <p class="text-sm text-gray-600">${user.email}</p>
                    </div>
                    <button onclick="deleteUser('${user.email.replace(/'/g, "\\'")}')" class="flex-shrink-0 p-2 text-sm bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                        Delete
                    </button>
                `;
                userList.appendChild(userDiv);
            });
        }

        async function deleteUser(email) {
            if (!confirm(`Are you sure you want to delete the user with email: ${email}?`)) return;
            const token = getToken();
            try {
                const res = await fetch(`https://test-ecommerce-backend-icgy.onrender.com/api/users/${encodeURIComponent(email)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        removeToken();
                        showLoginForm();
                        alert('Session expired. Please log in again.');
                    }
                    throw new Error('Failed to delete user.');
                }
                
                await res.json();
                loadUsers();
            } catch (err) {
                console.error('Delete failed:', err);
                alert('Failed to delete user.');
            }
        }

        userSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm)
            );
            renderUsers(filteredUsers);
        });

        // --- Order Management Functions ---
        async function loadOrders() {
            orderList.innerHTML = `<p class="text-center text-gray-500 flex items-center justify-center">
                                    <svg class="animate-spin h-5 w-5 mr-3 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg> Loading orders...
                                </p>`;

            try {
                const res = await fetch('https://test-ecommerce-backend-icgy.onrender.com/api/orders', {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
            
                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        removeToken();
                        showLoginForm();
                        alert('Session expired. Please log in again.');
                    }
                    throw new Error('Failed to load orders.');
                }
                
                const orders = await res.json();
                renderOrders(orders);
            } catch (err) {
                console.error('Failed to load orders:', err);
                orderList.innerHTML = '<p class="text-center text-red-500">Failed to load orders.</p>';
            }
        }

        function renderOrders(orders) {
            orderList.innerHTML = '';
            if (orders.length === 0) {
                orderList.innerHTML = '<p class="text-center text-gray-500">No orders found.</p>';
                return;
            }
            orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            orders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = `bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-200`;
                const orderItemsHtml = order.items.map(item => `
                    <li class="flex items-center space-x-2">
                        <img src="${item.image}" alt="${item.name}" class="w-8 h-8 rounded-md object-cover">
                        <span class="text-sm font-medium text-gray-700">${item.name}</span>
                        <span class="text-xs text-gray-500">(${item.quantity} x $${item.price})</span>
                    </li>
                `).join('');

                const orderTotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2);

                orderDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2 pb-2 border-b border-gray-200">
                        <h3 class="font-bold text-gray-900">Order #${order._id}</h3>
                        <span class="text-xs text-gray-500">${new Date(order.createdAt).toLocaleString()}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">
                        <span class="font-semibold">Customer:</span> ${order.shipping.name || order.user.email}
                    </p>
                    <p class="text-sm text-gray-600 mb-2">
                        <span class="font-semibold">Address:</span> ${order.shipping.address}
                    </p>
                    <p class="text-sm text-gray-600 mb-2">
                       <span class="font-semibold">Number:</span> ${order.shipping.phone}
                   </p>
                    <p class="text-sm text-gray-600 mb-2">
                        <span class="font-semibold">Total:</span> $<span class="font-bold text-indigo-700">${orderTotal}</span>
                    </p>
                    <p class="text-sm text-gray-600 mb-2">
                        <span class="font-semibold">Payment method:</span> <span class="text-green-600">${order.payment.method}</span>
                    </p>
                    <ul class="space-y-1 mt-3">
                        ${orderItemsHtml}
                    </ul>
                `;
                orderList.appendChild(orderDiv);
            });
        }
    </script>
</body>
</html>